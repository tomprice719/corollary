{% extends "templates/base_pills.html" %}

{% block content %}

{% if post %}
<div class = "row">
  <div class = "col-sm-8">
    <h2>{{post.title}}</h2>
    <div id="post-actions">
      Posted by <strong>{{post.author}}</strong>, {{post.date}}.
      <a href="/compose?selected={{selected}}" class="btn btn-primary btn-xs" data-toggle="modal">New child post</a>
      <a href ="/edit?selected={{selected}}" class="btn btn-primary btn-xs">edit</a>
      <a href="#confirm-delete" class="btn btn-primary btn-xs" data-toggle="modal">delete</a>
      <a href="#subscribe" class="btn btn-primary btn-xs" data-toggle="modal">subscribe</a>
    </div>

    <div id = "post-content">
      <div id = "popover-container"></div>
      {{post.processed_content|safe}}
    </div>

    <hr>
    {% if comments %}
      <h3 style = "padding-bottom: 0.5em">Comments</h3>
      {% for comment in comments %}
        <p><strong>{{comment.author}}</strong>, {{comment.date}}:</p>
        <p>{{comment.processed_content|safe}}</p>
      {% endfor %}
    {% endif %}

    <h3>Add a comment</h3>
    <form action="/add-comment" method="post">
      <fieldset class="form-group">
        <label>Your name</label>
        <input id="comment-author" type="text" name="name" class="form-control" placeholder="Enter your name">
      </fieldset>
      <fieldset class="form-group">
        <label>Comment</label>
        <textarea id="comment-content-area" class="form-control" name="content" rows="7" placeholder = "Enter your comment"></textarea>
        The markup language used is Pandoc-Markdown.
        <a href = "http://www.unexpected-vortices.com/sw/rippledoc/quick-markdown-example.html">
          See here for an example.
        </a>
      </fieldset>
      <input type="hidden" name="post-id" value = {{selected}} />
      <div class="clearfix">
        <div class="pull-right">
          <button id="preview-comment-button" type="button" class="btn btn-primary btn-lg" data-toggle="modal">Preview</button>
          <button type="submit" class="btn btn-primary btn-lg">Submit</button>
        </div>
      </div>
    </form>
  </div>

  <div id="parent-child-column" class = "col-sm-4">

    {% if post.parent_id %}
    <p>
    Parents:
    </p>
    <p>
      <a href="/selected?selected={{post.parent_id}}">{{post.parent_title}}</a>
    </p>

    {% else %}
    <p>
      Root Post
    </p>
    {% endif %}

    <p>Children:
    {% if children %}
    </p>
    {% for child in children %}
    <p>
      <a href="/selected?selected={{child.id}}">{{child.title}}</a>
    </p>
    {% endfor %}
    {% else %}
    None
  </p>
    {% endif %}
  </div>

</div>

<!-- Delete modal -->
<div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Confirm deletion</h4>
      </div>
      <div class="modal-body">
        Are you sure you want to delete the post "{{post.title}}"?
      </div>
      <div class="modal-footer">
        <form action="/delete-post" method="post">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <input type="hidden" name="id" value="{{selected}}" />
          <input class="btn btn-danger btn-ok" type="submit" value="Delete"/>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Subscribe modal -->
<div class="modal fade" id="subscribe" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Subscribe</h4>
      </div>
      <form role="form" action="/subscribe" method="post" data-toggle="validator">
      <div class="modal-body">
          Provide your email here to get notifications about new activity related to this post.
          <fieldset class="form-group" style = "padding-top:1em">
            <input id = "email-input" type="text" name="email" class="form-control" placeholder="Enter your email">
          </fieldset>
          <fieldset class="form-group">
            <input data-match="#email-input" type="text" name="email2" class="form-control" placeholder="Confirm your email">
            <div class="help-block with-errors"></div>
          </fieldset>
          <fieldset class="form-group">
            <input name="descs" type="checkbox" value = "true" checked>Also get notified about activity on descendants of
              this post.
          </fieldset>
      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <input type="hidden" name="id" value="{{selected}}" />
          <input class="btn btn-primary" type="submit" value="Ok"/>
      </div>
      </form>
    </div>
  </div>
</div>

<!-- Successfully subscribed modal -->
<div class="modal fade" id="subscribe-success" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Subscribed successfully</h4>
      </div>
        <div class="modal-body">
          You will now receive email notifications about new activity related to this post.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
    </div>
  </div>
</div>

<!-- Preview modal -->
<div id="previewModal" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">New Comment Preview</h4>
      </div>
      <div class="modal-body">
        <p><strong id="preview-author"></strong>:</p>
        <p id="preview-content"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

{% else %}

<h1>
  Post Not Found
</h1>

{% endif %}
{% endblock %}

{% block scripts %}
<script src='typeahead.bundle.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.5/validator.js'></script>

<script language = "javascript">

  {% if subscribed %}
  $(window).load(function(){
    $('#subscribe-success').modal('show');
   });
  {% endif %}

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });

  linkTypes = [];
  linkMap = {{link-map|safe}};

  // constructs the suggestion engine for link types
  var linkTypeBH = new Bloodhound({
    datumTokenizer: Bloodhound.tokenizers.whitespace,
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: linkTypes
  });

  $('#new-child-link-type .typeahead').typeahead({
    hint: true,
    highlight: true,
    minLength: 1
  },
                                                  {
    name: 'new-child-link-type',
    source: linkTypeBH
  });

  $("#preview-comment-button").click(function(){
    $.post("/preview-html", {selection: $("#comment-content-area").val()}, function(data) {
      $("#preview-author").html($("#comment-author").val());
      $("#preview-content").html(data);
      MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
      $("#previewModal").modal();
    }, "html");
  });

  $("#post-content a").each(function() {
    var href = $(this).attr("href");
    if (href in linkMap) {
      $(this).popover({content: linkMap[href].content, title: linkMap[href].title, trigger: "hover", html:true, container: "#popover-container", placement: "bottom"});
      $(this).mouseover(function () { MathJax.Hub.Queue(["Typeset",MathJax.Hub, "popover-container"])});
    }
  });

</script>

{% endblock %}
