{% extends "templates/base.html" %}

{% block content %}

<h1>
  {% if edit %}
  Edit Post
  {% else %}
  New post
  {% endif %}
</h1>

<form id = "form" action="{{form-action}}" method="post">
  <fieldset class="form-group">
    <label>Title</label>
    <input type="text" name="title" id="title-input" class="form-control" placeholder="Enter title" value = "{{title}}">
  </fieldset>
  <fieldset class="form-group">
    <label>Your name</label>
    <input type="text" name="name" class="form-control" placeholder="Enter name" value="{{author}}">
  </fieldset>
  <fieldset class="form-group">
    <label>Content</label>
    <textarea id="content-area" class="form-control" name="content" rows="15" placeholder = "Enter content">{{content}}</textarea>
    <small class="text-muted">
      The markup language used is Pandoc-Markdown.
      <a href = "http://www.unexpected-vortices.com/sw/rippledoc/quick-markdown-example.html">
        See here for an example.
      </a>
    </small>
  </fieldset>
  <div class="clearfix">
    <div class="pull-right">
      <button id="preview-all-button" type="button" class="btn btn-primary btn-md" data-toggle="modal">Preview All</button>
      <button id="preview-selection-button" type="button" class="btn btn-primary btn-md" data-toggle="modal">Preview Selection</button>
      <button id="hyperlink-open" type="button" class="btn btn-primary btn-md" data-toggle="modal" data-target="#addHyperlinkModal">Insert Hyperlink</button>
    </div>
  </div>
  <div class = "row form-group">
    <div class="col-sm-6">
      <h3>
        Parents
        <button type="button" class="btn btn-primary btn-md" data-toggle="modal" data-target="#addParentModal">Add parent</button>
      </h3>
      <ul id = "parents" class = "list-group">
      </ul>
    </div>
    <div class="col-sm-6">
      <h3>
        Children
        <button type="button" class="btn btn-primary btn-md" data-toggle="modal" data-target="#addChildModal">Add child</button>
      </h3>
      <ul id = "children" class = "list-group">
      </ul>
    </div>
  </div>

  <!-- Hidden input to include id of post, for editing an existing post -->
  <input type="hidden" name="id" value="{{id}}" />

  <!-- Hidden inputs to send parents / children -->
  <input type="hidden" name="parents" id = "parents-hidden-input"/>
  <input type="hidden" name="children" id = "children-hidden-input"/>

  <button type="submit" class="btn btn-primary btn-lg pull-right">Submit</button>
</form>

<!-- Modal -->
<div id="addParentModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Add Parent Post</h4>
      </div>
      <div class="modal-body">
        <p>Enter the title of the post you would like to add as a parent.</p>
        <div id = "new-parent-title">
          <input id="new-parent-title-input" class="typeahead form-control" />
        </div>
        <p>Enter the link type from the parent post to this post.</p>
        <div id = "new-parent-link-type">
          <input id="new-parent-link-type-input" class="typeahead form-control" />
        </div>
      </div>
      <div class="modal-footer">
        <button id="add-parent" type="button" class="btn btn-default" data-dismiss="modal">Ok</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<!-- Modal -->
<div id="addChildModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Add Parent Post</h4>
      </div>
      <div class="modal-body">
        <p>Enter the title of the post you would like to add as a child.</p>
        <div id = "new-child-title">
          <input id="new-child-title-input" class="typeahead form-control" />
        </div>
        <p>Enter the link type from this post to the child post.</p>
        <div id = "new-child-link-type">
          <input id="new-child-link-type-input" class="typeahead form-control" />
        </div>
      </div>
      <div class="modal-footer">
        <button id="add-child" type="button" class="btn btn-default" data-dismiss="modal">Ok</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<!-- Modal -->
<div id="addHyperlinkModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content 1-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Add Hyperlink</h4>
      </div>

      <div class="modal-body part1">
        <h3>
          Link to another post
        </h3>
        <fieldset class="form-group">
          <label>Post to link to</label>
          <div id = "hyperlink-post-title">
            <input id="hyperlink-post-title-input" class="typeahead form-control" />
          </div>
        </fieldset>
        <fieldset class="form-group">
          <label>Link label</label>
          <input type="text" id="hyperlink-label-input" class="form-control">
        </fieldset>
        <div class="clearfix">
          <button id="hyperlink-next" type="button" class="pull-right btn btn-default">Next</button>
        </div>
        <h3>
          Link to an external page
        </h3>
        Just use the syntax [link label](url).
      </div>

      <div class="modal-body part2 hidden">
        <p>
          Copy and paste this snippet to wherever you want to insert the link in your post:
        </p>
        <input type="text" id="hyperlink-snippet" class="form-control">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<!-- Modal -->
<div id="previewModal" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Preview</h4>
      </div>
      <div id = "previewBody" class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src='typeahead.bundle.js'></script>
<script src='underscore.js'></script>
<script src='backbone.js'></script>

<script language = "javascript">

  titleMap = {{title-map|safe}};
  linkTypes = {{link-types|safe}}

  ParentChildView = Backbone.View.extend({
    tagName: 'li',
    render: function(){
      this.$el.html(this.model.attributes['title']);
      $('<button />', {
        html: "remove",
        "class": "btn btn-primary btn-xs destroy pull-right"
      }).appendTo(this.$el);
      return this;
    },
    events: {
      'click .destroy': 'destroy'
    },
    destroy: function(){
      this.remove();
      this.collection.remove(this.model);
    }
  });

  parentList = new Backbone.Collection();
  childList = new Backbone.Collection();

  function getSelectionText() {
    // obtain the object reference for the <textarea>
    var txtarea = document.getElementById("content-area");
    // obtain the index of the first selected character
    var start = txtarea.selectionStart;
    // obtain the index of the last selected character
    var finish = txtarea.selectionEnd;
    // obtain the selected text
    return txtarea.value.substring(start, finish);
  }

  function addParent(title, linkType) {
    var model = new Backbone.Model({title: title, id: titleMap[title], linkType: linkType});
    parentList.add(model);
    var view = new ParentChildView({collection: parentList,
                                    model: model,
                                    className: "list-group-item"});
    $('#parents').prepend(view.render().el);
  }

  function addChild(title, linkType) {
    var model = new Backbone.Model({title: title, id: titleMap[title], linkType: linkType});
    childList.add(model);
    var view = new ParentChildView({collection: childList,
                                    model: model,
                                    className: "list-group-item"});
    $('#children').prepend(view.render().el);
  }

  $("#add-parent").click(function(){
    addParent($('#new-parent-title-input').val(), $('#new-parent-link-type-input').val());
    $('#new-parent-title-input').val('')
  });

  $("#add-child").click(function(){
    addChild($('#new-child-title-input').val(), $('#new-child-link-type-input').val())
    $('#new-child-title-input').val('');
  });

  $("#hyperlink-next").click(function(){
    // add link text
    label = $('#hyperlink-label-input').val()
    title = $('#hyperlink-post-title-input').val();
    if(!(title in titleMap)) {
      alert('Oops, there is no post with the title "' + title + '"!');
      return;
    }
    postId = titleMap[title];
    $('#hyperlink-snippet').val('[' + label + '](/selected?selected=' + postId + ')');
    // switch views
    $('#addHyperlinkModal .part1').addClass('hidden')
    $('#addHyperlinkModal .part2').removeClass('hidden')
    // erase inputs
    $('#hyperlink-post-title-input').val('');
    $('#hyperlink-label-input').val('');
  });

  $("#hyperlink-open").click(function(){
    // switch views
    $('#addHyperlinkModal .part1').removeClass('hidden')
    $('#addHyperlinkModal .part2').addClass('hidden')
  });

  $("#preview-selection-button").click(function(){
    $.post("/preview-html", {selection: getSelectionText()}, function(data) {
      $("#previewBody").html(data);
      console.log(data);
      MathJax.Hub.Queue(["Typeset",MathJax.Hub,"previewBody"]);
      $("#previewModal").modal();
    }, "html");
  });

  $("#preview-all-button").click(function(){
    $.post("/preview-html", {selection: $("#content-area").val()}, function(data) {
      $("#previewBody").html(data);
      MathJax.Hub.Queue(["Typeset",MathJax.Hub,"previewBody"]);
      $("#previewModal").modal();
    }, "html");
  });

  $("#form").submit( function(event) {
    if($("#title-input").val().trim() in titleMap) {
      alert( "There already exists a post with that title. You need to choose a unique title.");
      event.preventDefault();
    } else {
      $("#parents-hidden-input").val(JSON.stringify(parentList));
      $("#children-hidden-input").val(JSON.stringify(childList));
    }
  });

  // constructs the suggestion engine for titles
  var titleBH = new Bloodhound({
    datumTokenizer: Bloodhound.tokenizers.whitespace,
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: Object.keys(titleMap)
  });

  $('#new-parent-title .typeahead').typeahead({
    hint: true,
    highlight: true,
    minLength: 1
  },
                                              {
    name: 'new-parent-title',
    source: titleBH
  });

  $('#new-child-title .typeahead').typeahead({
    hint: true,
    highlight: true,
    minLength: 1
  },
                                             {
    name: 'new-child-title',
    source: titleBH
  });

  $('#hyperlink-post-title .typeahead').typeahead({
    hint: true,
    highlight: true,
    minLength: 1
  },
                                               {
    name: 'new-hyperlink-post-title',
    source: titleBH
  });

  // constructs the suggestion engine for link types
  var linkTypeBH = new Bloodhound({
    datumTokenizer: Bloodhound.tokenizers.whitespace,
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: linkTypes
  });

  $('#new-parent-link-type .typeahead').typeahead({
    hint: true,
    highlight: true,
    minLength: 1
  },
                                                  {
    name: 'new-parent-link-type',
    source: linkTypeBH
  });

  $('#new-child-link-type .typeahead').typeahead({
    hint: true,
    highlight: true,
    minLength: 1
  },
                                                 {
    name: 'new-child-link-type',
    source: linkTypeBH
  });

  {% if parents %}
  _.each({{parents|safe}}, function(parent) {
    addParent(parent.title, parent.edge_type);
  });
  {% endif %}

   {% if children %}
   _.each({{children|safe}}, function(child) {
     addChild(child.title, child.edge_type);
   });
  {% endif %}

</script>
{% endblock %}
