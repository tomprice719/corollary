{% extends "templates/base.html" %}

{% block content %}

<h1>
  {% if edit %}
  Edit Post
  {% else %}
  New post
  {% endif %}
</h1>

<form id = "form"
      action="{% if edit %}/update-post{% else %}/add-post{% endif %}"
      method="post">
  <fieldset class="form-group">
    <label>Title</label>
    <input type="text" name="title" id="title-input" class="form-control" placeholder="Enter title" value = "{{title}}">
  </fieldset>
  <fieldset class="form-group">
    <label>Your name</label>
    <input type="text" name="name" class="form-control" placeholder="Enter name" value="{{author}}">
  </fieldset>
  {% if parent-id %}
  <fieldset class="form-group">
    <label>Parent post:</label>
    <label id = "parent-label" style="padding-right: 1em">{{parent-title}}</label>
    <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#changeParentModal">Change</button>
  </fieldset>

  <!-- Hidden input to send parent id -->
  <input type="hidden" name="parent-id" id = "parent-hidden-input" value="{{parent-id}}"/>

  {% endif %}

  <fieldset class="form-group">
    <label>Hover Text</label>
    <p>
      An optional short summary of the post, displayed whenever someone hovers over a link to it. Only plain text and latex are allowed here, no markdown.
    </p>
    <textarea class="form-control" name="hover-text" rows="5">{{hover_text}}</textarea>
  </fieldset>

  <fieldset class="form-group">
    <label>Content</label>
    <p>
      The markup language used is Pandoc-Markdown.
      <a href = "http://www.unexpected-vortices.com/sw/rippledoc/quick-markdown-example.html">
        See here for an example.
      </a>
    </p>
    <textarea id="content-area" class="form-control" name="content" rows="15" placeholder = "Enter content">{{content}}</textarea>
  </fieldset>

  <fieldset class="form-group">
    <div class="clearfix">
      <div class="pull-right">
        <button id="preview-all-button" type="button" class="btn btn-primary btn-md" data-toggle="modal">Preview All</button>
        <button id="preview-selection-button" type="button" class="btn btn-primary btn-md" data-toggle="modal">Preview Selection</button>
        <button id="hyperlink-open" type="button" class="btn btn-primary btn-md" data-toggle="modal" data-target="#addHyperlinkModal">Insert Hyperlink</button>
      </div>
    </div>
  </fieldset>
  <!-- Hidden input to include id of post, for editing an existing post -->
  <input type="hidden" name="id" value="{{id}}" />
  <button type="submit" class="btn btn-primary btn-lg pull-right">Submit</button>
</form>

<!-- Change parent modal-->
<div id="changeParentModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Change Parent Post</h4>
      </div>
      <div class="modal-body">
        <p>Enter the title of the post you would like to make the parent.</p>
        <div id = "new-parent-title">
          <input id="new-parent-title-input" class="typeahead form-control" />
        </div>
      </div>
      <div class="modal-footer">
        <button id="change-parent-ok" type="button" class="btn btn-default" data-dismiss="modal">Ok</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>


<!-- Add link modal -->
<div id="addHyperlinkModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content 1-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Add Hyperlink</h4>
      </div>

      <div class="modal-body part1">
        <h3>
          Link to another post
        </h3>
        <fieldset class="form-group">
          <label>Post to link to</label>
          <div id = "hyperlink-post-title">
            <input id="hyperlink-post-title-input" class="typeahead form-control" />
          </div>
        </fieldset>
        <fieldset class="form-group">
          <label>Link label</label>
          <input type="text" id="hyperlink-label-input" class="form-control">
        </fieldset>
        <div class="clearfix">
          <button id="hyperlink-next" type="button" class="pull-right btn btn-default">Next</button>
        </div>
        <h3>
          Link to an external page
        </h3>
        Just use the syntax [link label](url).
      </div>

      <div class="modal-body part2 hidden">
        <p>
          Copy and paste this snippet to wherever you want to insert the link in your post:
        </p>
        <input type="text" id="hyperlink-snippet" class="form-control">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<!-- Preview modal -->
<div id="previewModal" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Preview</h4>
      </div>
      <div id = "previewBody" class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src='typeahead.bundle.js'></script>
<script src='underscore.js'></script>

<script language = "javascript">

  titleMap = {{title-map|safe}};

  function getSelectionText() {
    // obtain the object reference for the <textarea>
    var txtarea = document.getElementById("content-area");
    // obtain the index of the first selected character
    var start = txtarea.selectionStart;
    // obtain the index of the last selected character
    var finish = txtarea.selectionEnd;
    // obtain the selected text
    return txtarea.value.substring(start, finish);
  }

  $("#add-child").click(function(){
    addChild($('#new-child-title-input').val(), $('#new-child-link-type-input').val())
    $('#new-child-title-input').val('');
  });

  $("#hyperlink-next").click(function(){
    // add link text
    label = $('#hyperlink-label-input').val()
    title = $('#hyperlink-post-title-input').val();
    if(!(title in titleMap)) {
      alert('Oops, there is no post with the title "' + title + '"!');
      return;
    }
    postId = titleMap[title];
    $('#hyperlink-snippet').val('[' + label + '](/selected?selected=' + postId + ')');
    // switch views
    $('#addHyperlinkModal .part1').addClass('hidden')
    $('#addHyperlinkModal .part2').removeClass('hidden')
    // erase inputs
    $('#hyperlink-post-title-input').val('');
    $('#hyperlink-label-input').val('');
  });

  $("#change-parent-ok").click(function(){
    var title = $('#new-parent-title-input').val();
    if(!(title in titleMap)) {
      alert('Oops, there is no post with the title "' + title + '"!');
      return;
    }
    var parentId = titleMap[title];
    $('#parent-label').text(title);
    $('#parent-hidden-input').val(parentId);
  });

  $("#hyperlink-open").click(function(){
    // switch views
    $('#addHyperlinkModal .part1').removeClass('hidden')
    $('#addHyperlinkModal .part2').addClass('hidden')
  });

  $("#preview-selection-button").click(function(){
    var selection = getSelectionText();
    if(selection.trim() == "") {
      alert("You haven't selected anything.")
      return;
    }
    $.post("/preview-html", {selection: selection}, function(data) {
      $("#previewBody").html(data);
      console.log(data);
      MathJax.Hub.Queue(["Typeset",MathJax.Hub,"previewBody"]);
      $("#previewModal").modal();
    }, "html");
  });

  $("#preview-all-button").click(function(){
    $.post("/preview-html", {selection: $("#content-area").val()}, function(data) {
      $("#previewBody").html(data);
      MathJax.Hub.Queue(["Typeset",MathJax.Hub,"previewBody"]);
      $("#previewModal").modal();
    }, "html");
  });

  $("#form").submit( function(event) {
    if($("#title-input").val().trim() in titleMap) {
      alert( "There already exists a post with that title. You need to choose a unique title.");
      event.preventDefault();
    }
  });

  // constructs the suggestion engine for titles
  var titleBH = new Bloodhound({
    datumTokenizer: Bloodhound.tokenizers.whitespace,
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    local: Object.keys(titleMap)
  });

  $('#new-parent-title .typeahead').typeahead({
    hint: true,
    highlight: true,
    minLength: 1
  },
                                              {
    name: 'new-parent-title',
    source: titleBH
  });

  $('#hyperlink-post-title .typeahead').typeahead({
    hint: true,
    highlight: true,
    minLength: 1
  },
                                               {
    name: 'new-hyperlink-post-title',
    source: titleBH
  });

</script>
{% endblock %}
